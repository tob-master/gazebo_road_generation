%
%% Kapitel: Kapitel 4
%%======================================================================

\chapter{Suche von Bodenmarkierungen und Objekten in den Fahrspuren mit dem On-Road-Search-Algorithmus}
\label{cha:Suche von Bodenmarkierungen und Objekten in den Fahrspuren mit dem On-Road-Search-Algorithmus}
\index{Suche und Klassifizierung von Bodenmarkierungen und Objekten in den Fahrspuren mit dem On-Road-Search-Algorithmus}
%
%
In folgenden Abschnitten wird auf die entwickelten Verfahren zur Erkennung von Bodenmarkierungen und von Objekten in der Fahrbahn und der Startbox eingegangen.
Um eine bessere \"Ubersicht zu bekommen wird der Programmablaufplan zu Anfang des Kapitels vorgestellt.

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.8\textwidth]{/home/tb/gazebo_road_generation/02_Arbeit_Latex/007_Kapitel6/Bilder/on_road_search_finish1}% keine extention: wählt jpg für DVI
  \caption[Programmablaufplan des On-Road-Search-Algorithmus Teil 1]%
           {\label{fig:ors1}%
           Programmablaufplan des On-Road-Search-Algorithmus Teil 1}
\end{center}
\end{figure}

\newpage

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.8\textwidth]{/home/tb/gazebo_road_generation/02_Arbeit_Latex/007_Kapitel6/Bilder/on_road_search_finish2}% keine extention: wählt jpg für DVI
  \caption[Programmablaufplan des On-Road-Search-Algorithmus Teil 2]%
           {\label{fig:ors2}%
           Programmablaufplan des On-Road-Search-Algorithmus Teil 2}
\end{center}
\end{figure}

\newpage 

\section{Startboxschrankenerkennung}
\label{sec:Startboxschrankenerkennung}

Die Startboxschrankenerkennung nutzt die Softwarebibliothek Zbar.
Zbar ist eine Open-Source-Bibliothek zum Lesen von C-Barcodes und QR-Codes.
Es wurde sich dazu entschieden den QR-Code der Startboxschranke zu erkennen, da dieser nur einmal auf der gesamten Fahrstrecke vorkommt. Zbar ist rechenintensiv jedoch kann der Algorithmus einfach nach dem Öffnen der Schranke ausgeschalten werden und fällt dadurch nicht mehr ins Gewicht.
Um das Erkennen der Startboxschranke testen zu können, wurde mit Qt/QML eine Grafische Benutzeroberfläche implementiert.

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.5\textwidth]{/home/tb/gazebo_road_generation/02_Arbeit_Latex/008_Kapitel7/Bilder/gui}% keine extention: wählt jpg für DVI
  \caption[Die Grafische Benutzeroberfläche für das Testen der Startboxschrankenerkennung]%
           {\label{fig:Grafische Benutzeroberfläche}%
           Die Grafische Benutzeroberfläche für das Testen der Startboxschrankenerkennung}
\end{center}
\end{figure}

Mit dieser kann das Modell der Startboxschranke in der Simulation erzeugt und wieder gelöscht werden.
Außerdem besitzt die GUI einen Subscriber auf die QR-Code-Topic barcode und zeigt bei Erkennen der Startboxschranke in der GUI den erkannten Text an.
Um dafür zu sorgen, dass die GUI nicht einfriert und jederzeit auf Signale reagieren kann, wurde die GUI in einem separaten Thread nebenläufig zu ROS implementiert.

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.5\textwidth]{/home/tb/gazebo_road_generation/02_Arbeit_Latex/008_Kapitel7/Bilder/startbox}% keine extention: wählt jpg für DVI
  \caption[Die erzeugte Startboxschranke]%
           {\label{fig:Startboxschranke}%
           Die erzeugte Startboxschranke.}
\end{center}
\end{figure}


\section{Zebrastreifen- und Ziellinienerkennung}
\label{sec:Zebrastreifen- und Ziellinienerkennung}

Um Zebrastreifen und Ziellinien im aktuellen Bild zu erkennen, wird nach einer festgelegten Anzahl von aufeinanderfolgenden weißen und schwarzen Pixelsegmenten mit einer definierten breite gesucht.
Das Verfahren arbeitet auf dem Graustufenbild in der Birdseye-Perspektive.
Der Algorithmus setzt dabei auf die Startparameter des Start-of-Lines-Search-Algorithmus oder des Vanishing-Point-Algorithmus auf. Die Startparameter von Start-of-Lines-Search werden dabei präferiert.
Es wird eine zu vorausschauende Distanz und eine Schrittweite definiert, in der vor dem Fahrzeug nach dem Muster der Fahrbahnmarkierungen gesucht wird.
Die Zebrastreifensuche iteriert orthogonal zu dem Startwinkel aus Startparameters. Dafür wird die OpenCV-Funktion Lineiterator genutzt.
Diese iteriert von einem Startpunkt hin zu einem Endpunkt durch das Bild und liest die darunter liegenden Pixel aus. Wird eine gewisse Anzahl weißer und schwarzer Segmente mit der entsprechenden Breite gefunden, ist der Zebrastreifen erkannt.

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.4\textwidth]{/home/tb/gazebo_road_generation/02_Arbeit_Latex/008_Kapitel7/Bilder/crosswalk}% keine extention: wählt jpg für DVI
  \caption[Ein detektierter Zebrastreifen in der Fahrbahn]%
           {\label{fig:Zebrastreifensuche}%
           Ein detektierter Zebrastreifen in der Fahrbahn.}
\end{center}
\end{figure}

Die Ziellinienerkennung sucht von der linken Außenlinie orthogonal zu dem Startwinkel von Startparameters nach Segmenten mit der entsprechenden Breite. Auch sie nutzt die OpenCV-Funktion Lineiterator.
Da die Ziellinie im CaroloCup häufig nach einer Kurve erkannt werden muss, wird ein Sichtfeld durch einen Winkel definiert, welches durch wiederholtes Aufrufen von Lineiterator in einer festgelegten Schrittweite durchsucht wird. 

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.5\textwidth]{/home/tb/gazebo_road_generation/02_Arbeit_Latex/008_Kapitel7/Bilder/goalline_search}% keine extention: wählt jpg für DVI
  \caption[Darstellung des Sichtfelds der Zielliniensuche]%
           {\label{fig:Zielliniensuche}%
           Darstellung des Sichtfelds der Zielliniensuche.}
\end{center}
\end{figure}

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.4\textwidth]{/home/tb/gazebo_road_generation/02_Arbeit_Latex/008_Kapitel7/Bilder/goalline}% keine extention: wählt jpg für DVI
  \caption[Eine detektierte Ziellinie in der Fahrbahn]%
           {\label{fig:Zielliniensuche}%
           Eine detektierte Ziellinie in der Fahrbahn.}
\end{center}
\end{figure}


\newpage


\section{Kreuzungserkennung}
\label{sec:Kreuzungserkennung}

Um eine Kreuzung zu erkennen, werden die aus Line-Validation-Table-Creator erzeugten Bewertungstabellen analysiert. Die linke Linie wird nach einem Winkel durchsucht der zwischen 160 und 200 Grad liegt. Die rechte Linie wird nach einem Winkel durchsucht der zwischen 340 und 20 Grad liegt. Auch die Mittelliniengruppen werden darauf überprüft ob sie horizontal zwischen bestimmten Winkelwerten orientiert sind. 
Zudem werden die Bewertungstabellen in Fahrtrichtung daraufhin überprüft ob sie eine gewisse Länge nicht überschreiten. Umso mehr markante Merkmale gefunden werden, umso höher ist wie Wahrscheinlichkeit das sich im aktuellen Frame eine Kreuzung befindet.

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.3\textwidth]{/home/tb/gazebo_road_generation/02_Arbeit_Latex/008_Kapitel7/Bilder/crossing}% keine extention: wählt jpg für DVI
  \caption[Eine detektierte Kreuzung]%
           {\label{fig:Kreuzungserkennung}%
           Eine detektierte Kreuzung.}
\end{center}
\end{figure}






\section{Bodenmarkierungs- und Hinderniserkennung}
\label{sec:Bodenmarkierungs- und Hinderniserkennung}

Wird im Bild keine Kreuzung ,Ziellinie und kein Zebrastreifen erkannt, dann wird das Verfahren der Bodenmarkierungs- und Hinderniserkennung ausgeführt.
Das Verfahren arbeitet auf dem Graustufenbild in Birdseye-Perspektive.
Der Algorithmus setzt auf die gefundenen Außenlinienpunkte des Line-Validation-Table-Creators in Fahrtrichtung auf.
Orthogonal zu den Richtungswinkeln der Außenlinienpunkte wird ein Muster bestehenden aus einem Kreis und einer den Kreis in der Mitte durchlaufenden Linie in beiden Fahrspuren ausgelesen.
Für das Auslesen der Linie wird die OpenCV-Funktion Lineiterator verwendet.
Das Auslesen des Kreises wird mit der Funktion radialScan realisiert.
Von beiden Außenlinien aus, kann in beiden Fahrspuren nach Hindernissen und Bodenmarkierungen gesucht werden. Eine definierte Suchweite mit zugehöriger Schrittweite legt fest, wie weit für vor dem Fahrzeug gesucht werden soll.

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.4\textwidth]{/home/tb/gazebo_road_generation/02_Arbeit_Latex/008_Kapitel7/Bilder/marking_box_search}% keine extention: wählt jpg für DVI
  \caption[Das Suchmuster der Bodenmarkierung- und Hinderniserkennung]%
           {\label{fig:Das Suchmuster der Bodenmarkierung- und Hinderniserkennung}%
           Das Suchmuster der Bodenmarkierung- und Hinderniserkennung.}
\end{center}
\end{figure}


Wie auch bei der Ziellinien- und Zebrastreifensuche wird nach dem Auftauchen eines bestimmten Segmenten-Musters gesucht.
Um ein Hindernis zu erkennen, muss ein Segment in der Suchlinie gefunden werden, welches über einer festgelegten Breite liegt. Dies gilt auch für die radiale Suche.
Werden viele kleinere Segmente in der entsprechenden Fahrspur gefunden deutet dies auf eine Bodenmarkierung hin.

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.4\textwidth]{/home/tb/gazebo_road_generation/02_Arbeit_Latex/008_Kapitel7/Bilder/box}% keine extention: wählt jpg für DVI
  \caption[Eine detektierte Box in der Fahrbahn]%
           {\label{fig:Erkennung eines Hindernisses}%
           Eine detektierte Box in der Fahrbahn.}
\end{center}
\end{figure}


\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.4\textwidth]{/home/tb/gazebo_road_generation/02_Arbeit_Latex/008_Kapitel7/Bilder/marking}% keine extention: wählt jpg für DVI
  \caption[Erkennung detektierte Bodenmarkierung in der Fahrbahn]%
           {\label{fig:Erkennung einer Bodenmarkierung}%
           Eine detektierte Geschwindigkeitsbegrenzungsmarkierung in der Fahrbahn.}
\end{center}
\end{figure}


